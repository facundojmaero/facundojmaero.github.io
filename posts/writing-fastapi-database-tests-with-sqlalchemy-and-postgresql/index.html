<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="canonical" href="https://astro-paper.pages.dev/posts/writing-fastapi-database-tests-with-sqlalchemy-and-postgresql/">
    <meta name="generator" content="Astro v2.1.3">

    <!-- General Meta Tags -->
    <title>Writing FastAPI database tests with SQLAlchemy and PostgreSQL</title>
    <meta name="title" content="Writing FastAPI database tests with SQLAlchemy and PostgreSQL">
    <meta name="description" content="Writing FastAPI database tests with SQLAlchemy and PostgreSQL">
    <meta name="author" content="Facundo Maero">

    <!-- Open Graph / Facebook -->
    <meta property="og:title" content="Writing FastAPI database tests with SQLAlchemy and PostgreSQL">
    <meta property="og:description" content="Writing FastAPI database tests with SQLAlchemy and PostgreSQL">
    <meta property="og:url" content="https://astro-paper.pages.dev/posts/writing-fastapi-database-tests-with-sqlalchemy-and-postgresql/">
    <meta property="og:image" content="https://res.cloudinary.com/noezectz/v1663745737/astro-paper/astropaper-x-forestry-og_kqfwp0.png">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://astro-paper.pages.dev/posts/writing-fastapi-database-tests-with-sqlalchemy-and-postgresql/">
    <meta property="twitter:title" content="Writing FastAPI database tests with SQLAlchemy and PostgreSQL">
    <meta property="twitter:description" content="Writing FastAPI database tests with SQLAlchemy and PostgreSQL">
    <meta property="twitter:image" content="https://res.cloudinary.com/noezectz/v1663745737/astro-paper/astropaper-x-forestry-og_kqfwp0.png">

    <!-- Google Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:ital,wght@0,400;0,500;0,600;0,700;1,400;1,600&display=swap" rel="stylesheet">

    

    <script src="/toggle-theme.js"></script>
  <link rel="stylesheet" href="/_astro/about.c428ab9b.css" />
<link rel="stylesheet" href="/_astro/about.9dee87f4.css" />
<link rel="stylesheet" href="/_astro/_slug_.faea2550.css" />
<link rel="stylesheet" href="/_astro/_slug_.77dedcfe.css" />
<link rel="stylesheet" href="/_astro/_slug_.5d5f7e01.css" />
<link rel="stylesheet" href="/_astro/_slug_.d833ca2a.css" /><script type="module">const e=document.querySelector(".hamburger-menu"),n=document.querySelector("#menu-items")?.classList,t=document.querySelector(".icon-container")?.classList,o=document.querySelector("#first-line")?.classList,a=document.querySelector("#second-line ")?.classList,s=document.querySelector("#third-line")?.classList;e?.addEventListener("click",function(){e?.getAttribute("aria-expanded")==="false"?(e?.setAttribute("aria-expanded","true"),e?.setAttribute("aria-label","Close Menu"),n?.remove("display-none"),t?.remove("flex"),t?.add("relative"),o?.add("rotate-45","absolute","bottom-1/2"),s?.add("display-none"),a?.add("!w-full","-rotate-45","absolute","bottom-1/2")):(e?.setAttribute("aria-expanded","false"),e?.setAttribute("aria-label","Open Menu"),n?.add("display-none"),t?.add("flex"),t?.remove("relative"),o?.remove("rotate-45","absolute","bottom-1/2"),s?.remove("display-none"),a?.remove("!w-full","-rotate-45","absolute","bottom-1/2"))});
</script></head>
  <body>
    <header class="astro-3EF6KSR2">
  <a id="skip-to-content" href="#main-content" class="astro-3EF6KSR2">Skip to content</a>
  <div class="nav-container astro-3EF6KSR2">
    <div class="top-nav-wrap astro-3EF6KSR2">
      <a href="/" class="logo astro-3EF6KSR2">
        Facundo&#39;s Blog
      </a>
      <nav id="nav-menu" class="astro-3EF6KSR2">
        <button class="hamburger-menu focus-outline astro-3EF6KSR2" aria-label="Open Menu" aria-expanded="false" aria-controls="menu-items">
          <div class="icon-container flex astro-3EF6KSR2">
            <div id="first-line" class="astro-3EF6KSR2"></div>
            <div id="second-line" class="astro-3EF6KSR2"></div>
            <div id="third-line" class="astro-3EF6KSR2"></div>
          </div>
        </button>
        <ul id="menu-items" class="display-none sm:flex astro-3EF6KSR2">
          <li class="astro-3EF6KSR2">
            <a href="/posts" class=" astro-3EF6KSR2">
              Posts
            </a>
          </li>
          <li class="astro-3EF6KSR2">
            <a href="/tags" class=" astro-3EF6KSR2">
              Tags
            </a>
          </li>
          <li class="astro-3EF6KSR2">
            <a href="/about" class=" astro-3EF6KSR2">
              About
            </a>
          </li>
          <li class="astro-3EF6KSR2">
            <a type="button" href="/search" tabindex="0" class="group focus-outline p-3 sm:p-1  astro-3EF6KSR2 astro-5EUNQZKT" aria-label="search" title="Search">
  <svg xmlns="http://www.w3.org/2000/svg" class="scale-125 sm:scale-100 astro-3EF6KSR2"><path d="M19.023 16.977a35.13 35.13 0 0 1-1.367-1.384c-.372-.378-.596-.653-.596-.653l-2.8-1.337A6.962 6.962 0 0 0 16 9c0-3.859-3.14-7-7-7S2 5.141 2 9s3.14 7 7 7c1.763 0 3.37-.66 4.603-1.739l1.337 2.8s.275.224.653.596c.387.363.896.854 1.384 1.367l1.358 1.392.604.646 2.121-2.121-.646-.604c-.379-.372-.885-.866-1.391-1.36zM9 14c-2.757 0-5-2.243-5-5s2.243-5 5-5 5 2.243 5 5-2.243 5-5 5z" class="astro-3EF6KSR2"></path>
              </svg>
</a>
          </li>
          <li class="astro-3EF6KSR2">
            <button id="theme-btn" class="focus-outline astro-3EF6KSR2" title="Toggles light & dark" aria-label="auto" aria-live="polite">
                  <svg xmlns="http://www.w3.org/2000/svg" id="moon-svg" class="astro-3EF6KSR2">
                    <path d="M20.742 13.045a8.088 8.088 0 0 1-2.077.271c-2.135 0-4.14-.83-5.646-2.336a8.025 8.025 0 0 1-2.064-7.723A1 1 0 0 0 9.73 2.034a10.014 10.014 0 0 0-4.489 2.582c-3.898 3.898-3.898 10.243 0 14.143a9.937 9.937 0 0 0 7.072 2.93 9.93 9.93 0 0 0 7.07-2.929 10.007 10.007 0 0 0 2.583-4.491 1.001 1.001 0 0 0-1.224-1.224zm-2.772 4.301a7.947 7.947 0 0 1-5.656 2.343 7.953 7.953 0 0 1-5.658-2.344c-3.118-3.119-3.118-8.195 0-11.314a7.923 7.923 0 0 1 2.06-1.483 10.027 10.027 0 0 0 2.89 7.848 9.972 9.972 0 0 0 7.848 2.891 8.036 8.036 0 0 1-1.484 2.059z" class="astro-3EF6KSR2"></path>
                  </svg>
                  <svg xmlns="http://www.w3.org/2000/svg" id="sun-svg" class="astro-3EF6KSR2">
                    <path d="M6.993 12c0 2.761 2.246 5.007 5.007 5.007s5.007-2.246 5.007-5.007S14.761 6.993 12 6.993 6.993 9.239 6.993 12zM12 8.993c1.658 0 3.007 1.349 3.007 3.007S13.658 15.007 12 15.007 8.993 13.658 8.993 12 10.342 8.993 12 8.993zM10.998 19h2v3h-2zm0-17h2v3h-2zm-9 9h3v2h-3zm17 0h3v2h-3zM4.219 18.363l2.12-2.122 1.415 1.414-2.12 2.122zM16.24 6.344l2.122-2.122 1.414 1.414-2.122 2.122zM6.342 7.759 4.22 5.637l1.415-1.414 2.12 2.122zm13.434 10.605-1.414 1.414-2.122-2.122 1.414-1.414z" class="astro-3EF6KSR2"></path>
                  </svg>
                </button>
          </li>
        </ul>
      </nav>
    </div>
  </div>
  <div class="max-w-3xl mx-auto px-4">
  <hr class="border-skin-line" aria-hidden="true">
</div>
</header><div class="mx-auto flex w-full max-w-3xl justify-start px-2 astro-VJ4TPSPI">
    <button class="focus-outline mt-8 mb-2 flex hover:opacity-75 astro-VJ4TPSPI" onclick="history.back()">
      <svg xmlns="http://www.w3.org/2000/svg" class="astro-VJ4TPSPI"><path d="M13.293 6.293 7.586 12l5.707 5.707 1.414-1.414L10.414 12l4.293-4.293z" class="astro-VJ4TPSPI"></path>
      </svg><span class="astro-VJ4TPSPI">Go back</span>
    </button>
  </div><main id="main-content" class="astro-VJ4TPSPI">
    <h1 class="post-title astro-VJ4TPSPI">Writing FastAPI database tests with SQLAlchemy and PostgreSQL</h1>
    <div class="flex items-center space-x-2 opacity-80 my-2 astro-VJ4TPSPI"><svg xmlns="http://www.w3.org/2000/svg" class="scale-100 inline-block h-6 w-6 fill-skin-base" aria-hidden="true"><path d="M7 11h2v2H7zm0 4h2v2H7zm4-4h2v2h-2zm0 4h2v2h-2zm4-4h2v2h-2zm0 4h2v2h-2z"></path><path d="M5 22h14c1.103 0 2-.897 2-2V6c0-1.103-.897-2-2-2h-2V2h-2v2H9V2H7v2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2zM19 8l.001 12H5V8h14z"></path></svg><span class="sr-only">Posted on:</span><span class="italic text-base">August 31, 2021<span aria-hidden="true"> | </span><span class="sr-only"> at </span>09:00 AM</span></div>
    <article id="article" role="article" class="prose mx-auto mt-8 max-w-3xl astro-VJ4TPSPI">
      <p><img src="/assets/alex-gorbi-ETSuraUW390-unsplash.jpg" alt="Introducing AstroPaper 2.0"></p>
<h2 id="table-of-contents">Table of contents</h2>
<p></p><details><summary>Open Table of contents</summary><p></p>
<ul>
<li>
<p><a href="#the-api">The API</a></p>
</li>
<li>
<p><a href="#setting-things-up">Setting things up</a></p>
<ul>
<li><a href="#the-database-session">The database session</a></li>
</ul>
</li>
<li>
<p><a href="#writing-tests">Writing tests</a></p>
<ul>
<li><a href="#using-factoryboy">Using factoryboy</a></li>
<li><a href="#using-subfactories">Using SubFactories</a></li>
<li><a href="#factories-as-fixtures">Factories as Fixtures</a></li>
</ul>
</li>
<li>
<p><a href="#conclusion">Conclusion</a></p>
</li>
</ul>
<p></p></details><p></p>
<h2 id="the-api">The API</h2>
<p>The project is a small application that’s used to register Formula 1
information. It handles two types of resources: Drivers and Teams, and it
looks like this:</p>
<pre is:raw="" class="astro-code" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;"><code><span class="line"><span style="color: #abb2bf">- GET   /teams      -> read F1 Teams</span></span>
<span class="line"><span style="color: #abb2bf">- POST  /teams      -> create a new Team</span></span>
<span class="line"><span style="color: #abb2bf">- GET   /drivers    -> read F1 Drivers</span></span>
<span class="line"><span style="color: #abb2bf">- POST  /drivers    -> create a new Driver</span></span></code></pre>
<p>Teams can be created on their own, but to create a Driver we need to specify
the Team that signed them.
Let’s see some CURL examples, assuming the API runs on <code>localhost:8080</code>:</p>
<pre is:raw="" class="astro-code" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;"><code><span class="line"><span style="color: #7F848E"># Create a Team</span></span>
<span class="line"><span style="color: #ABB2BF">curl --header </span><span style="color: #98C379">"Content-Type: application/json"</span><span style="color: #ABB2BF"> \</span></span>
<span class="line"><span style="color: #ABB2BF">  --request POST \</span></span>
<span class="line"><span style="color: #ABB2BF">  --data </span><span style="color: #98C379">'{"name":"Red Bull Racing"}'</span><span style="color: #ABB2BF"> \</span></span>
<span class="line"><span style="color: #ABB2BF">  http://localhost:8080/teams</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E"># Create a Driver of that Team</span></span>
<span class="line"><span style="color: #ABB2BF">curl --header </span><span style="color: #98C379">"Content-Type: application/json"</span><span style="color: #ABB2BF"> \</span></span>
<span class="line"><span style="color: #ABB2BF">  --request POST \</span></span>
<span class="line"><span style="color: #ABB2BF">  --data </span><span style="color: #98C379">'{"name":"Max Verstappen", "number": 33, "nationality": "dutch", "team_id": 1}'</span><span style="color: #ABB2BF"> \</span></span>
<span class="line"><span style="color: #ABB2BF">  http://localhost:8080/drivers</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E"># Get all Drivers</span></span>
<span class="line"><span style="color: #ABB2BF">curl http://localhost:8080/drivers</span></span></code></pre>
<h2 id="setting-things-up">Setting things up</h2>
<p>To test this API we’ll use <a href="https://pypi.org/project/pytest/">pytest</a>.</p>
<p>The tests we’ll write here are integration tests, meaning we don’t want to mock
different modules of our app, but want to see things working from making an
HTTP request to getting the response, all while going to the database to store
the data.</p>
<p>What are we working with? The stack is composed of a FastAPI application which
uses SQLAlchemy to interface with Postgres.</p>
<p>To test our app we need some sort of <strong>client</strong>, an object that
can make HTTP requests and deliver the response. Maybe you’re thinking of
<a href="https://pypi.org/project/requests/">requests</a> or
<a href="https://pypi.org/project/httpx/">httpx</a>, two famous libraries
in Python. But luckily FastAPI provides its own <code>TestClient</code>, so that’s what
we’re gonna use today<sup><a href="#user-content-fn-1" id="user-content-fnref-1" data-footnote-ref="" aria-describedby="footnote-label">1</a></sup>.</p>
<h3 id="the-database-session">The database session</h3>
<p>All of our endpoints use a db <strong>session</strong>, requested on-demand to a
session factory. This factory is bound to an <strong>engine</strong> connected to Postgres
itself.</p>
<p>Assume we have a production database that we <strong>don’t</strong> want to touch while
testing, so one thing we could do is create a test database that’s exactly the
same just for testing, and then create an <strong>engine</strong> and a <strong>sessionmaker</strong>
connected to that db.
The following fixture provides the discussed functionality:</p>
<pre is:raw="" class="astro-code" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;"><code><span class="line"><span style="color: #61AFEF">@pytest</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">fixture</span></span>
<span class="line"><span style="color: #C678DD">def</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">db_fixture</span><span style="color: #ABB2BF">():</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #D19A66">SQLALCHEMY_DATABASE_URL</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">"postgresql://postgres:password@localhost:5433/f1.db"</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    engine </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">create_engine</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">SQLALCHEMY_DATABASE_URL</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">    testing_session_local </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">sessionmaker</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">autocommit</span><span style="color: #56B6C2">=</span><span style="color: #D19A66">False</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">autoflush</span><span style="color: #56B6C2">=</span><span style="color: #D19A66">False</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">bind</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">engine)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">try</span><span style="color: #ABB2BF">:</span></span>
<span class="line"><span style="color: #ABB2BF">        Base.metadata.</span><span style="color: #61AFEF">create_all</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">bind</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">engine)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">        db </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">testing_session_local</span><span style="color: #ABB2BF">()</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD">yield</span><span style="color: #ABB2BF"> db</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">finally</span><span style="color: #ABB2BF">:</span></span>
<span class="line"><span style="color: #ABB2BF">        db.</span><span style="color: #61AFEF">close</span><span style="color: #ABB2BF">()</span></span>
<span class="line"><span style="color: #ABB2BF">        Base.metadata.</span><span style="color: #61AFEF">drop_all</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">bind</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">engine)</span></span></code></pre>
<p>If you’ve never seen pytest fixtures, think of it like this: they replace the
<code>setUp</code> and <code>tearDown</code> functions used in languages like Java and the like.</p>
<p>Fixtures are functions that you can call to get some data or perform some task
you need in a test. They can do things <strong>before</strong> a test (like the <code>setUp</code>
hook) and/or <strong>after</strong> a test (like the <code>tearDown</code> hook).</p>
<p>These functions are not meant to be called directly. Instead, they are
“required” by every test that needs them. This is performed by defining them
as function arguments of your tests (or other fixtures).</p>
<p>Here we’re setting up everything we need to create database sessions.
Then, we create the actual table structure in the db and yield a new db
session.</p>
<p>Everything that runs <strong>before</strong> the <code>yield</code> expression happens <strong>before</strong> the
actual test code and everything <strong>after</strong> is considered teardown code.</p>
<p>When the test is done, we’re closing the session and destroying the whole
database, in order to make sure our tests are independent of each other.
There are better ways to handle this setup and teardown procedure, but that’s
a story for another day.</p>
<p>The last thing we need is a way of getting a <code>TestClient</code> bound to our api.</p>
<pre is:raw="" class="astro-code" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;"><code><span class="line"><span style="color: #61AFEF">@pytest</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">fixture</span><span style="color: #ABB2BF">()</span></span>
<span class="line"><span style="color: #C678DD">def</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">client</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">db_fixture</span><span style="color: #ABB2BF">):</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">def</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">override_get_db</span><span style="color: #ABB2BF">():</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD">yield</span><span style="color: #ABB2BF"> db_fixture</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    app.dependency_overrides[get_db] </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> override_get_db</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">yield</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">TestClient</span><span style="color: #ABB2BF">(app)</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">del</span><span style="color: #ABB2BF"> app.dependency_overrides[get_db]</span></span></code></pre>
<p>In production code, the db session is provided by a function called <code>get_db</code>.
Here we’re overriding it with our own function that returns a session to the
newly created test db. You can find more information about overriding
FastAPI dependencies <a href="https://fastapi.tiangolo.com/uk/advanced/testing-database/">in the official docs</a>.</p>
<h2 id="writing-tests">Writing tests</h2>
<p>Now that we have the needed basic fixtures, let’s write our first test that
creates an F1 Team:</p>
<pre is:raw="" class="astro-code" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;"><code><span class="line"><span style="color: #C678DD">def</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">test_create_one_team</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">client</span><span style="color: #ABB2BF">):</span></span>
<span class="line"><span style="color: #ABB2BF">    team_data </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> {</span><span style="color: #98C379">"name"</span><span style="color: #ABB2BF">: </span><span style="color: #98C379">"Scuderia Ferrari"</span><span style="color: #ABB2BF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    response </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> client.</span><span style="color: #61AFEF">post</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"/teams"</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">json</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">team_data)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    received </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> response.</span><span style="color: #61AFEF">json</span><span style="color: #ABB2BF">()</span></span>
<span class="line"><span style="color: #ABB2BF">    expected </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> {</span><span style="color: #98C379">"id"</span><span style="color: #ABB2BF">: </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">"name"</span><span style="color: #ABB2BF">: </span><span style="color: #98C379">"Scuderia Ferrari"</span><span style="color: #ABB2BF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">assert</span><span style="color: #ABB2BF"> response.status_code </span><span style="color: #56B6C2">==</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">200</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">assert</span><span style="color: #ABB2BF"> received </span><span style="color: #56B6C2">==</span><span style="color: #ABB2BF"> expected</span></span></code></pre>
<p>We’re defining the data to send in <code>team_data</code>, making a POST request and
verifying the response is what we sent.</p>
<p>Since we’re setting up and tearing down the database between tests, we can
run it as many times as we want and it will always work.</p>
<p>Next test! Now let’s check the GET request:</p>
<pre is:raw="" class="astro-code" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;"><code><span class="line"><span style="color: #C678DD">def</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">test_get_team</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">client</span><span style="color: #ABB2BF">):</span></span>
<span class="line"><span style="color: #ABB2BF">    team_data </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> {</span><span style="color: #98C379">"name"</span><span style="color: #ABB2BF">: </span><span style="color: #98C379">"Scuderia Ferrari"</span><span style="color: #ABB2BF">}</span></span>
<span class="line"><span style="color: #ABB2BF">    _ </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> client.</span><span style="color: #61AFEF">post</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"/teams"</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">json</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">team_data)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    response </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> client.</span><span style="color: #61AFEF">get</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"/teams"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    expected </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> [{</span><span style="color: #98C379">"id"</span><span style="color: #ABB2BF">: </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">"name"</span><span style="color: #ABB2BF">: team_data[</span><span style="color: #98C379">"name"</span><span style="color: #ABB2BF">]}]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">assert</span><span style="color: #ABB2BF"> response.status_code </span><span style="color: #56B6C2">==</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">200</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">assert</span><span style="color: #ABB2BF"> response.</span><span style="color: #61AFEF">json</span><span style="color: #ABB2BF">() </span><span style="color: #56B6C2">==</span><span style="color: #ABB2BF"> expected</span></span></code></pre>
<p>Here we’re creating a Team, then fetching all Teams, and checking the retrieved
list has the newly created Team in it.</p>
<p>Again, since the db is empty, to test we can get a Team, we need to create it
first. This works, but can we do better? This code has some issues, let’s see
why.</p>
<p>In order to test the <strong>retrieval</strong> of a Team, we need to <strong>create</strong> one with
another endpoint. Lucky us we have that <code>POST /teams</code> endpoint lying around
right? But what happens if our API contract didn’t have a POST endpoint like
that? In other words, here we had to use one endpoint to test another.</p>
<p>Maybe a better way would be to interact with the database “behind the scenes”
to create the resource we need, and only interact with the endpoint we’re
testing at the moment. Let’s do that:</p>
<pre is:raw="" class="astro-code" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;"><code><span class="line"><span style="color: #C678DD">from</span><span style="color: #ABB2BF"> src </span><span style="color: #C678DD">import</span><span style="color: #ABB2BF"> crud</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">def</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">test_get_team_orm</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">client</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">db_fixture</span><span style="color: #ABB2BF">):</span></span>
<span class="line"><span style="color: #ABB2BF">    team_data </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> {</span><span style="color: #98C379">"name"</span><span style="color: #ABB2BF">: </span><span style="color: #98C379">"Scuderia Ferrari"</span><span style="color: #ABB2BF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    crud.</span><span style="color: #61AFEF">create_team</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">db</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">db_fixture, </span><span style="color: #E06C75">team</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">team_data)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    response </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> client.</span><span style="color: #61AFEF">get</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"/teams"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    expected </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> [{</span><span style="color: #98C379">"id"</span><span style="color: #ABB2BF">: </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">"name"</span><span style="color: #ABB2BF">: team_data[</span><span style="color: #98C379">"name"</span><span style="color: #ABB2BF">]}]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">assert</span><span style="color: #ABB2BF"> response.status_code </span><span style="color: #56B6C2">==</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">200</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">assert</span><span style="color: #ABB2BF"> response.</span><span style="color: #61AFEF">json</span><span style="color: #ABB2BF">() </span><span style="color: #56B6C2">==</span><span style="color: #ABB2BF"> expected</span></span></code></pre>
<p>We’re using the <code>client</code> only once, and we’re creating a Team using the <code>crud</code>
module from our application directly.</p>
<p>Analysis time again. The <code>team_data</code> is defined here in the test case and used
to create the record and make the test assertion. When more test cases are
written, this variable will be needed again and again. Sounds like we can write
another fixture right?</p>
<p>Well, yes, and no. A fixture to avoid repeating Team data is definitely a good
idea, but what if we want to create a Team with another name? Or create more
than one Team in a single test?
We would need to grab the fixture, make a copy, and edit some attributes.</p>
<p>See where I’m going? Sometimes these fixtures are not as flexible as we wish
for use cases like this.</p>
<h3 id="using-factoryboy">Using factoryboy</h3>
<p>There’s a handy Python library called
<a href="https://pypi.org/project/factory-boy/">factoryboy</a> that can help us with this
fixture issue. According to their own docs:</p>
<blockquote>
<p>As a fixtures replacement tool, [factoryboy] aims to replace static, hard to
maintain fixtures with easy-to-use factories for complex objects.</p>
</blockquote>
<p>A factory is a class that builds objects. When you define them, you specify the
attributes of this object, as well as default values that can be overridden
later.</p>
<p>Our api has a <code>schemas</code> module with the shape of data expected by each endpoint.
This way, we can define a factory for each schema and use them in our tests.
Let’s see an example:</p>
<pre is:raw="" class="astro-code" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;"><code><span class="line"><span style="color: #C678DD">import</span><span style="color: #ABB2BF"> factory</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">class</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">TeamCreateFactory</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">factory</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Factory</span><span style="color: #ABB2BF">):</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">class</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Meta</span><span style="color: #ABB2BF">:</span></span>
<span class="line"><span style="color: #ABB2BF">        model </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> schemas.TeamCreate</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    name </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> factory.</span><span style="color: #61AFEF">Sequence</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">lambda</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">n</span><span style="color: #ABB2BF">: </span><span style="color: #C678DD">f</span><span style="color: #98C379">"Team </span><span style="color: #D19A66">{</span><span style="color: #ABB2BF">n</span><span style="color: #D19A66">}</span><span style="color: #98C379">"</span><span style="color: #ABB2BF">)</span></span></code></pre>
<p>Here we defined a factory class, assigned the model class to create
(<code>TeamCreate</code> in this case), and wrote the fields one by one.
These fields can take hardcoded values or can be dynamically assigned using
<code>Sequences</code> or other factories (more on this later).</p>
<p>So how do these factories help us in the previous test cases? Let’s see a simple
example:</p>
<pre is:raw="" class="astro-code" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;"><code><span class="line"><span style="color: #C678DD">def</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">test_create_one_team_factoryboy</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">client</span><span style="color: #ABB2BF">):</span></span>
<span class="line"><span style="color: #ABB2BF">    team_data </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> factories.</span><span style="color: #61AFEF">TeamCreateFactory</span><span style="color: #ABB2BF">()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    response </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> client.</span><span style="color: #61AFEF">post</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"/teams"</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">json</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">team_data.</span><span style="color: #61AFEF">dict</span><span style="color: #ABB2BF">())</span></span>
<span class="line"><span style="color: #ABB2BF">    expected </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> {</span><span style="color: #98C379">"id"</span><span style="color: #ABB2BF">: </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">"name"</span><span style="color: #ABB2BF">: team_data.name}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">assert</span><span style="color: #ABB2BF"> response.status_code </span><span style="color: #56B6C2">==</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">200</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">assert</span><span style="color: #ABB2BF"> response.</span><span style="color: #61AFEF">json</span><span style="color: #ABB2BF">() </span><span style="color: #56B6C2">==</span><span style="color: #ABB2BF"> expected</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">def</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">test_create_one_team_factoryboy_custom_name</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">client</span><span style="color: #ABB2BF">):</span></span>
<span class="line"><span style="color: #ABB2BF">    team_data </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> factories.</span><span style="color: #61AFEF">TeamCreateFactory</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">name</span><span style="color: #56B6C2">=</span><span style="color: #98C379">"Mercedes-AMG"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    response </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> client.</span><span style="color: #61AFEF">post</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"/teams"</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">json</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">team_data.</span><span style="color: #61AFEF">dict</span><span style="color: #ABB2BF">())</span></span>
<span class="line"><span style="color: #ABB2BF">    expected </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> {</span><span style="color: #98C379">"id"</span><span style="color: #ABB2BF">: </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">"name"</span><span style="color: #ABB2BF">: </span><span style="color: #98C379">"Mercedes-AMG"</span><span style="color: #ABB2BF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">assert</span><span style="color: #ABB2BF"> response.status_code </span><span style="color: #56B6C2">==</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">200</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">assert</span><span style="color: #ABB2BF"> response.</span><span style="color: #61AFEF">json</span><span style="color: #ABB2BF">() </span><span style="color: #56B6C2">==</span><span style="color: #ABB2BF"> expected</span></span></code></pre>
<p>Here the <code>team_data</code> creation is handled by our factory. Calling it gives us
a new <code>schemas.TeamCreate</code> object with default attributes, but they
can be overridden using <code>kwargs</code>, as seen in the second test.</p>
<p>This could be fantastic for testing our app! Think about it, we could have
a Team factory, and a Driver factory, so we just call them without having to
worry about it in every test.</p>
<p>We can push this a bit further, and let <code>factoryboy</code> handle database record
creation. This means we could call a factory and it would go to the database,
create a record and give it back. All that in a single line of code.</p>
<p>As explained <a href="https://factoryboy.readthedocs.io/en/stable/orms.html#sqlalchemy">in the docs</a>,
when working with SQLAlchemy, factories need access to a <code>session</code> to interact
with the database, set in the <code>sqlalchemy_session</code> metaclass attribute.
So a factory that’s able to create db records would look like this:</p>
<pre is:raw="" class="astro-code" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;"><code><span class="line"><span style="color: #C678DD">class</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">TeamModelFactory</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">factory</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">alchemy</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">SQLAlchemyModelFactory</span><span style="color: #ABB2BF">):</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">class</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Meta</span><span style="color: #ABB2BF">:</span></span>
<span class="line"><span style="color: #ABB2BF">        model </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> database.Team</span></span>
<span class="line"><span style="color: #ABB2BF">        sqlalchemy_session </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> session</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    name </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> factory.</span><span style="color: #61AFEF">Sequence</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">lambda</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">n</span><span style="color: #ABB2BF">: </span><span style="color: #C678DD">f</span><span style="color: #98C379">"Team </span><span style="color: #D19A66">{</span><span style="color: #ABB2BF">n</span><span style="color: #D19A66">}</span><span style="color: #98C379">"</span><span style="color: #ABB2BF">)</span></span></code></pre>
<p>But where does this <code>session</code> come from? <a href="https://factoryboy.readthedocs.io/en/stable/orms.html#managing-sessions">The docs</a>
suggest using a <code>scoped_session</code> to request a session when the factories are
called.
In other words, factories need a way to get a session <em>at coding time</em>,
but we can’t do that. Remember, our db sessions are obtained as dependencies
when an endpoint needs them. That’s when the code is executed when the actual
production code is called.</p>
<p>So how do we fix this? One way consists of a fixture that requests a session
and gives it to factories. We would be creating factories and then injecting
the session using fixtures. Sounds confusing but it’s not that weird, look:</p>
<pre is:raw="" class="astro-code" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;"><code><span class="line"><span style="color: #C678DD">class</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">SQLAlchemyFactory</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">factory</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">alchemy</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">SQLAlchemyModelFactory</span><span style="color: #ABB2BF">):</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">class</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Meta</span><span style="color: #ABB2BF">:</span></span>
<span class="line"><span style="color: #ABB2BF">        abstract </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">True</span></span>
<span class="line"><span style="color: #ABB2BF">        sqlalchemy_session_persistence </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">"flush"</span></span>
<span class="line"></span>
<span class="line"><span style="color: #61AFEF">    @</span><span style="color: #56B6C2">classmethod</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">def</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">save_db_session</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">cls</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">session</span><span style="color: #ABB2BF">) -> </span><span style="color: #D19A66">None</span><span style="color: #ABB2BF">:</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E5C07B">cls</span><span style="color: #ABB2BF">._meta.sqlalchemy_session </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> session</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD">for</span><span style="color: #ABB2BF"> cls_attr </span><span style="color: #C678DD">in</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">vars</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">cls</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">values</span><span style="color: #ABB2BF">():</span></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">hasattr</span><span style="color: #ABB2BF">(cls_attr, </span><span style="color: #98C379">"get_factory"</span><span style="color: #ABB2BF">):</span></span>
<span class="line"><span style="color: #ABB2BF">                cls_attr.</span><span style="color: #61AFEF">get_factory</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">save_db_session</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">session</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">session)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">class</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">TeamModelFactory</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">SQLAlchemyFactory</span><span style="color: #ABB2BF">):</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">class</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Meta</span><span style="color: #ABB2BF">:</span></span>
<span class="line"><span style="color: #ABB2BF">        model </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> database.Team</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    name </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> factory.</span><span style="color: #61AFEF">Sequence</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">lambda</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">n</span><span style="color: #ABB2BF">: </span><span style="color: #C678DD">f</span><span style="color: #98C379">"Team </span><span style="color: #D19A66">{</span><span style="color: #ABB2BF">n</span><span style="color: #D19A66">}</span><span style="color: #98C379">"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #61AFEF">@pytest</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">fixture</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">autouse</span><span style="color: #56B6C2">=</span><span style="color: #D19A66">True</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #C678DD">def</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">_setup_factories</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">db_fixture</span><span style="color: #ABB2BF">):</span></span>
<span class="line"><span style="color: #ABB2BF">    TeamModelFactory.</span><span style="color: #61AFEF">save_db_session</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">session</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">db_fixture)</span></span></code></pre>
<p>The <code>SQLAlchemyFactory</code> is our new base class. It has a <code>save_db_session</code> method
that’s called by fixtures <strong>before</strong> each test is run.
The method also loops over the class fields to set the session in any
subfactory, if any.</p>
<p>Then we define a new factory that inherits from this new base class, same as
before.</p>
<p>Finally, the moment of truth. Let’s use our fancy new factory to create a
database record automatically!</p>
<pre is:raw="" class="astro-code" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;"><code><span class="line"><span style="color: #C678DD">def</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">test_get_team_sqlalchemy_factory</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">client</span><span style="color: #ABB2BF">):</span></span>
<span class="line"><span style="color: #ABB2BF">    created_team </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> factories.</span><span style="color: #61AFEF">TeamModelFactory</span><span style="color: #ABB2BF">()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    response </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> client.</span><span style="color: #61AFEF">get</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"/teams"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    expected </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> [{</span><span style="color: #98C379">"id"</span><span style="color: #ABB2BF">: </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">"name"</span><span style="color: #ABB2BF">: created_team.name}]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">assert</span><span style="color: #ABB2BF"> response.status_code </span><span style="color: #56B6C2">==</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">200</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">assert</span><span style="color: #ABB2BF"> response.</span><span style="color: #61AFEF">json</span><span style="color: #ABB2BF">() </span><span style="color: #56B6C2">==</span><span style="color: #ABB2BF"> expected</span></span></code></pre>
<p>No requiring a db session explicitly and no repeating fixture data.
The <code>TeamModelFactory()</code> call does all for us. We can even use it to create many
Teams using the <code>create_batch</code> method:</p>
<pre is:raw="" class="astro-code" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;"><code><span class="line"><span style="color: #C678DD">def</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">test_get_many_teams_sqlalchemy_factory</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">client</span><span style="color: #ABB2BF">):</span></span>
<span class="line"><span style="color: #ABB2BF">    created_teams </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> factories.TeamModelFactory.</span><span style="color: #61AFEF">create_batch</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">3</span><span style="color: #ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    response </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> client.</span><span style="color: #61AFEF">get</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"/teams"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">assert</span><span style="color: #ABB2BF"> response.status_code </span><span style="color: #56B6C2">==</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">200</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">assert</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">len</span><span style="color: #ABB2BF">(response.</span><span style="color: #61AFEF">json</span><span style="color: #ABB2BF">()) </span><span style="color: #56B6C2">==</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">3</span></span></code></pre>
<p>This approach is overkill for such a simple example, but I hope you
can imagine its potential when used with more complex database schemas and data
relations.</p>
<h3 id="using-subfactories">Using SubFactories</h3>
<p>To get a bit closer to real life, let’s write a factory to create a Driver:</p>
<pre is:raw="" class="astro-code" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;"><code><span class="line"><span style="color: #C678DD">class</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">DriverModelFactory</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">SQLAlchemyFactory</span><span style="color: #ABB2BF">):</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">class</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Meta</span><span style="color: #ABB2BF">:</span></span>
<span class="line"><span style="color: #ABB2BF">        model </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> database.Driver</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #56B6C2">id</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> factory.</span><span style="color: #61AFEF">Sequence</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">lambda</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">n</span><span style="color: #ABB2BF">: n)</span></span>
<span class="line"><span style="color: #ABB2BF">    name </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> factory.</span><span style="color: #61AFEF">Iterator</span><span style="color: #ABB2BF">([</span><span style="color: #98C379">"Facundo"</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">"Joaquin"</span><span style="color: #ABB2BF">])</span></span>
<span class="line"><span style="color: #ABB2BF">    number </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> factory.</span><span style="color: #61AFEF">Sequence</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">lambda</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">n</span><span style="color: #ABB2BF">: n)</span></span>
<span class="line"><span style="color: #ABB2BF">    nationality </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> factory.</span><span style="color: #61AFEF">Iterator</span><span style="color: #ABB2BF">([</span><span style="color: #98C379">"Argentina"</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">"France"</span><span style="color: #ABB2BF">])</span></span>
<span class="line"><span style="color: #ABB2BF">    team </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> factory.</span><span style="color: #61AFEF">SubFactory</span><span style="color: #ABB2BF">(TeamModelFactory)</span></span></code></pre>
<p>This factory looks just like the Teams one, but since we cannot create a Driver
without a Team, we need to set that link somewhere. This is where a <code>SubFactory</code>
comes in handy. We’re telling factoryboy that the <code>team</code> attribute of a Driver
is filled with the output of a <code>TeamModelFactory</code>.</p>
<p>A test that uses this class could look like this:</p>
<pre is:raw="" class="astro-code" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;"><code><span class="line"><span style="color: #C678DD">def</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">test_get_drivers</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">client</span><span style="color: #ABB2BF">):</span></span>
<span class="line"><span style="color: #ABB2BF">    driver </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> factories.</span><span style="color: #61AFEF">DriverModelFactory</span><span style="color: #ABB2BF">()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    response </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> client.</span><span style="color: #61AFEF">get</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"/drivers"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">    expected </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> [</span></span>
<span class="line"><span style="color: #ABB2BF">        {</span></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #98C379">"id"</span><span style="color: #ABB2BF">: driver.id,</span></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #98C379">"name"</span><span style="color: #ABB2BF">: driver.name,</span></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #98C379">"number"</span><span style="color: #ABB2BF">: driver.number,</span></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #98C379">"nationality"</span><span style="color: #ABB2BF">: driver.nationality,</span></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #98C379">"team"</span><span style="color: #ABB2BF">: {</span></span>
<span class="line"><span style="color: #ABB2BF">                </span><span style="color: #98C379">"name"</span><span style="color: #ABB2BF">: driver.team.name,</span></span>
<span class="line"><span style="color: #ABB2BF">            }</span></span>
<span class="line"><span style="color: #ABB2BF">        }</span></span>
<span class="line"><span style="color: #ABB2BF">    ]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">assert</span><span style="color: #ABB2BF"> response.status_code </span><span style="color: #56B6C2">==</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">200</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">assert</span><span style="color: #ABB2BF"> response.</span><span style="color: #61AFEF">json</span><span style="color: #ABB2BF">() </span><span style="color: #56B6C2">==</span><span style="color: #ABB2BF"> expected</span></span></code></pre>
<p>Again, think about this. With one line of code, we’re creating two database
records. Tests can’t get simpler than this, right?</p>
<h3 id="factories-as-fixtures">Factories as Fixtures</h3>
<p>Well, we can go one tiny step further. Remember when we talked about using
fixtures as a way of “requiring” things we need in tests? What if we could tell
pytest that we want to create a Driver by using a fixture?</p>
<p>A package called <a href="https://pypi.org/project/pytest-factoryboy/">pytest-factoryboy</a>
does just that. It makes <code>factoryboy</code> act like proper pytest fixtures, making
these tests even better.</p>
<p>The only change we need to use fixtures like this is to <code>register</code> our
factories. This will tell pytest a couple of new fixtures are available.</p>
<pre is:raw="" class="astro-code" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;"><code><span class="line"><span style="color: #61AFEF">register</span><span style="color: #ABB2BF">(TeamModelFactory)</span></span>
<span class="line"><span style="color: #61AFEF">register</span><span style="color: #ABB2BF">(TeamCreateFactory)</span></span>
<span class="line"><span style="color: #61AFEF">register</span><span style="color: #ABB2BF">(DriverModelFactory)</span></span></code></pre>
<p>Once the factories are registered, they are available in two ways:</p>
<ul>
<li>The factory itself is available as a fixture named like the factory class
(<code>TeamModelFactory</code> becomes <code>team_model_factory</code>, <code>TeamCreateFactory</code> becomes
<code>team_create_factory</code> and so on)</li>
<li>You can just ask pytest to create an object and give it to you by using
the <code>model</code> class name (<code>database.Team</code> becomes <code>team</code>, <code>database.Driver</code>
becomes <code>driver</code>)</li>
</ul>
<p>Let’s see some examples to illustrate this:</p>
<pre is:raw="" class="astro-code" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;"><code><span class="line"><span style="color: #C678DD">def</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">test_get_many_teams_sqlalchemy_factory_pytest</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">client</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">team_model_factory</span><span style="color: #ABB2BF">):</span></span>
<span class="line"><span style="color: #ABB2BF">    created_teams </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> team_model_factory.</span><span style="color: #61AFEF">create_batch</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">3</span><span style="color: #ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    response </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> client.</span><span style="color: #61AFEF">get</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"/teams"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">assert</span><span style="color: #ABB2BF"> response.status_code </span><span style="color: #56B6C2">==</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">200</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">assert</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">len</span><span style="color: #ABB2BF">(response.</span><span style="color: #61AFEF">json</span><span style="color: #ABB2BF">()) </span><span style="color: #56B6C2">==</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">3</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">def</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">test_get_team_sqlalchemy_factory_pytest</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">client</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">team</span><span style="color: #ABB2BF">):</span></span>
<span class="line"><span style="color: #ABB2BF">    response </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> client.</span><span style="color: #61AFEF">get</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"/teams"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    expected </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> [{</span><span style="color: #98C379">"id"</span><span style="color: #ABB2BF">: </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">"name"</span><span style="color: #ABB2BF">: team.name}]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">assert</span><span style="color: #ABB2BF"> response.status_code </span><span style="color: #56B6C2">==</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">200</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">assert</span><span style="color: #ABB2BF"> response.</span><span style="color: #61AFEF">json</span><span style="color: #ABB2BF">() </span><span style="color: #56B6C2">==</span><span style="color: #ABB2BF"> expected</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">def</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">test_get_drivers_sqlalchemy_factory_pytest</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">client</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">driver</span><span style="color: #ABB2BF">):</span></span>
<span class="line"><span style="color: #ABB2BF">    response </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> client.</span><span style="color: #61AFEF">get</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"/drivers"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">    expected </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> [</span></span>
<span class="line"><span style="color: #ABB2BF">        {</span></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #98C379">"id"</span><span style="color: #ABB2BF">: driver.id,</span></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #98C379">"name"</span><span style="color: #ABB2BF">: driver.name,</span></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #98C379">"number"</span><span style="color: #ABB2BF">: driver.number,</span></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #98C379">"nationality"</span><span style="color: #ABB2BF">: driver.nationality,</span></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #98C379">"team"</span><span style="color: #ABB2BF">: {</span></span>
<span class="line"><span style="color: #ABB2BF">                </span><span style="color: #98C379">"name"</span><span style="color: #ABB2BF">: driver.team.name,</span></span>
<span class="line"><span style="color: #ABB2BF">            },</span></span>
<span class="line"><span style="color: #ABB2BF">        }</span></span>
<span class="line"><span style="color: #ABB2BF">    ]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">assert</span><span style="color: #ABB2BF"> response.status_code </span><span style="color: #56B6C2">==</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">200</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">assert</span><span style="color: #ABB2BF"> response.</span><span style="color: #61AFEF">json</span><span style="color: #ABB2BF">() </span><span style="color: #56B6C2">==</span><span style="color: #ABB2BF"> expected</span></span></code></pre>
<p>These factories even support pytest’s very powerful <code>parametrize</code> functionality
to customize the built object using a <a href="https://pytest-factoryboy.readthedocs.io/en/latest/#attributes-are-fixtures">double underscore</a>:</p>
<pre is:raw="" class="astro-code" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;"><code><span class="line"><span style="color: #61AFEF">@pytest</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">mark</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">parametrize</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"team__name"</span><span style="color: #ABB2BF">,</span><span style="color: #61AFEF"> </span><span style="color: #ABB2BF">[</span><span style="color: #98C379">"Alpine F1 Team"</span><span style="color: #ABB2BF">])</span></span>
<span class="line"><span style="color: #C678DD">def</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">test_get_team_sqlalchemy_factory_pytest_custom</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">client</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">team</span><span style="color: #ABB2BF">):</span></span>
<span class="line"><span style="color: #ABB2BF">    response </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> client.</span><span style="color: #61AFEF">get</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"/teams"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    expected </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> [{</span><span style="color: #98C379">"id"</span><span style="color: #ABB2BF">: </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">"name"</span><span style="color: #ABB2BF">: </span><span style="color: #98C379">"Alpine F1 Team"</span><span style="color: #ABB2BF">}]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">assert</span><span style="color: #ABB2BF"> response.status_code </span><span style="color: #56B6C2">==</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">200</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">assert</span><span style="color: #ABB2BF"> response.</span><span style="color: #61AFEF">json</span><span style="color: #ABB2BF">() </span><span style="color: #56B6C2">==</span><span style="color: #ABB2BF"> expected</span></span>
<span class="line"></span>
<span class="line"><span style="color: #61AFEF">@pytest</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">mark</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">parametrize</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"driver__name"</span><span style="color: #ABB2BF">,</span><span style="color: #61AFEF"> </span><span style="color: #ABB2BF">[</span><span style="color: #98C379">"Valtteri Bottas"</span><span style="color: #ABB2BF">])</span></span>
<span class="line"><span style="color: #61AFEF">@pytest</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">mark</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">parametrize</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"driver__number"</span><span style="color: #ABB2BF">,</span><span style="color: #61AFEF"> </span><span style="color: #ABB2BF">[</span><span style="color: #D19A66">77</span><span style="color: #ABB2BF">])</span></span>
<span class="line"><span style="color: #C678DD">def</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">test_get_drivers_sqlalchemy_factory_pytest_custom</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">client</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">driver</span><span style="color: #ABB2BF">):</span></span>
<span class="line"><span style="color: #ABB2BF">    response </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> client.</span><span style="color: #61AFEF">get</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"/drivers"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">    expected </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> [</span></span>
<span class="line"><span style="color: #ABB2BF">        {</span></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #98C379">"id"</span><span style="color: #ABB2BF">: driver.id,</span></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #98C379">"name"</span><span style="color: #ABB2BF">: </span><span style="color: #98C379">"Valtteri Bottas"</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #98C379">"number"</span><span style="color: #ABB2BF">: </span><span style="color: #D19A66">77</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #98C379">"nationality"</span><span style="color: #ABB2BF">: driver.nationality,</span></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #98C379">"team"</span><span style="color: #ABB2BF">: {</span></span>
<span class="line"><span style="color: #ABB2BF">                </span><span style="color: #98C379">"name"</span><span style="color: #ABB2BF">: driver.team.name,</span></span>
<span class="line"><span style="color: #ABB2BF">            },</span></span>
<span class="line"><span style="color: #ABB2BF">        }</span></span>
<span class="line"><span style="color: #ABB2BF">    ]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">assert</span><span style="color: #ABB2BF"> response.status_code </span><span style="color: #56B6C2">==</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">200</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">assert</span><span style="color: #ABB2BF"> response.</span><span style="color: #61AFEF">json</span><span style="color: #ABB2BF">() </span><span style="color: #56B6C2">==</span><span style="color: #ABB2BF"> expected</span></span></code></pre>
<p>Last cool feature: we can register factories by giving them a name, and
overriding some of their attributes, to get more specific objects when needed:</p>
<pre is:raw="" class="astro-code" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;"><code><span class="line"><span style="color: #61AFEF">register</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #ABB2BF">    TeamModelFactory,</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">"red_bull"</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">name</span><span style="color: #56B6C2">=</span><span style="color: #98C379">"Red Bull Racing"</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #61AFEF">register</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #ABB2BF">    DriverModelFactory,</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">"max_verstappen"</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">name</span><span style="color: #56B6C2">=</span><span style="color: #98C379">"Max Verstappen"</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">number</span><span style="color: #56B6C2">=</span><span style="color: #D19A66">33</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">nationality</span><span style="color: #56B6C2">=</span><span style="color: #98C379">"Dutch"</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">team</span><span style="color: #56B6C2">=</span><span style="color: #61AFEF">LazyFixture</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"red_bull"</span><span style="color: #ABB2BF">),</span></span>
<span class="line"><span style="color: #ABB2BF">)</span></span></code></pre>
<p>We’re registering a fixture called <code>red_bull</code> and another called
<code>max_verstappen</code>. They are regular fixtures but all (or some) of the data is
overridden.</p>
<pre is:raw="" class="astro-code" style="background-color: #282c34; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;"><code><span class="line"><span style="color: #C678DD">def</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">test_get_red_bull</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">client</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">red_bull</span><span style="color: #ABB2BF">):</span></span>
<span class="line"><span style="color: #ABB2BF">    response </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> client.</span><span style="color: #61AFEF">get</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"/teams"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    expected </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> [{</span><span style="color: #98C379">"id"</span><span style="color: #ABB2BF">: </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">"name"</span><span style="color: #ABB2BF">: </span><span style="color: #98C379">"Red Bull Racing"</span><span style="color: #ABB2BF">}]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">assert</span><span style="color: #ABB2BF"> response.status_code </span><span style="color: #56B6C2">==</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">200</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">assert</span><span style="color: #ABB2BF"> response.</span><span style="color: #61AFEF">json</span><span style="color: #ABB2BF">() </span><span style="color: #56B6C2">==</span><span style="color: #ABB2BF"> expected</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">def</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">test_get_verstappen</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">client</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">max_verstappen</span><span style="color: #ABB2BF">):</span></span>
<span class="line"><span style="color: #ABB2BF">    response </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> client.</span><span style="color: #61AFEF">get</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"/drivers"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">    expected </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> [</span></span>
<span class="line"><span style="color: #ABB2BF">        {</span></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #98C379">"id"</span><span style="color: #ABB2BF">: max_verstappen.id,</span></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #98C379">"name"</span><span style="color: #ABB2BF">: </span><span style="color: #98C379">"Max Verstappen"</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #98C379">"number"</span><span style="color: #ABB2BF">: </span><span style="color: #D19A66">33</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #98C379">"nationality"</span><span style="color: #ABB2BF">: </span><span style="color: #98C379">"Dutch"</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #98C379">"team"</span><span style="color: #ABB2BF">: {</span></span>
<span class="line"><span style="color: #ABB2BF">                </span><span style="color: #98C379">"name"</span><span style="color: #ABB2BF">: </span><span style="color: #98C379">"Red Bull Racing"</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">            },</span></span>
<span class="line"><span style="color: #ABB2BF">        }</span></span>
<span class="line"><span style="color: #ABB2BF">    ]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">assert</span><span style="color: #ABB2BF"> response.status_code </span><span style="color: #56B6C2">==</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">200</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">assert</span><span style="color: #ABB2BF"> response.</span><span style="color: #61AFEF">json</span><span style="color: #ABB2BF">() </span><span style="color: #56B6C2">==</span><span style="color: #ABB2BF"> expected</span></span>
<span class="line"></span></code></pre>
<h2 id="conclusion">Conclusion</h2>
<p>Writing integration tests for a FastAPI project can be a difficult task, but
tools like <code>factoryboy</code> and its plugins can help a lot, even with a naive
API such as the one presented here.</p>
<p>If you want, you can check out the <a href="https://github.com/facundojmaero/blog-projects/tree/main/fastapi-db-tests-factoryboy">full code of this article</a>.
It has instructions on how to set everything up and run the tests yourself.
PRs and comments are welcome!</p>
<section data-footnotes="" class="footnotes"><h2 class="sr-only" id="footnote-label">Footnotes</h2>
<ol>
<li id="user-content-fn-1">
<p>Fun fact: FastAPI’s <code>TestClient</code> itself uses <code>requests</code> under the hood. <a href="#user-content-fnref-1" data-footnote-backref="" class="data-footnote-backref" aria-label="Back to content">↩</a></p>
</li>
</ol>
</section>
    </article>

    <ul class="tags-container astro-VJ4TPSPI">
      <li class="inline-block my-1 underline-offset-4 astro-BLWJYJPT">
  <a href="/tags/python" class="text-sm pr-2 group astro-BLWJYJPT">
    <svg xmlns="http://www.w3.org/2000/svg" class=" scale-75 astro-BLWJYJPT"><path d="M16.018 3.815 15.232 8h-4.966l.716-3.815-1.964-.37L8.232 8H4v2h3.857l-.751 4H3v2h3.731l-.714 3.805 1.965.369L8.766 16h4.966l-.714 3.805 1.965.369.783-4.174H20v-2h-3.859l.751-4H21V8h-3.733l.716-3.815-1.965-.37zM14.106 14H9.141l.751-4h4.966l-.752 4z" class="astro-BLWJYJPT"></path>
    </svg>
    &nbsp;<span class="astro-BLWJYJPT">python</span>
  </a>
</li><li class="inline-block my-1 underline-offset-4 astro-BLWJYJPT">
  <a href="/tags/testing" class="text-sm pr-2 group astro-BLWJYJPT">
    <svg xmlns="http://www.w3.org/2000/svg" class=" scale-75 astro-BLWJYJPT"><path d="M16.018 3.815 15.232 8h-4.966l.716-3.815-1.964-.37L8.232 8H4v2h3.857l-.751 4H3v2h3.731l-.714 3.805 1.965.369L8.766 16h4.966l-.714 3.805 1.965.369.783-4.174H20v-2h-3.859l.751-4H21V8h-3.733l.716-3.815-1.965-.37zM14.106 14H9.141l.751-4h4.966l-.752 4z" class="astro-BLWJYJPT"></path>
    </svg>
    &nbsp;<span class="astro-BLWJYJPT">testing</span>
  </a>
</li><li class="inline-block my-1 underline-offset-4 astro-BLWJYJPT">
  <a href="/tags/fastapi" class="text-sm pr-2 group astro-BLWJYJPT">
    <svg xmlns="http://www.w3.org/2000/svg" class=" scale-75 astro-BLWJYJPT"><path d="M16.018 3.815 15.232 8h-4.966l.716-3.815-1.964-.37L8.232 8H4v2h3.857l-.751 4H3v2h3.731l-.714 3.805 1.965.369L8.766 16h4.966l-.714 3.805 1.965.369.783-4.174H20v-2h-3.859l.751-4H21V8h-3.733l.716-3.815-1.965-.37zM14.106 14H9.141l.751-4h4.966l-.752 4z" class="astro-BLWJYJPT"></path>
    </svg>
    &nbsp;<span class="astro-BLWJYJPT">fastapi</span>
  </a>
</li>
    </ul>
  </main><footer class="mt-auto astro-SZ7XMLTE">
  <div class="max-w-3xl mx-auto px-0">
  <hr class="border-skin-line" aria-hidden="true">
</div>
  <div class="footer-wrapper astro-SZ7XMLTE">
    <div class="social-icons flex astro-UPU6FZXR">
  <a type="button" href="https://github.com/facundojmaero" tabindex="0" class="group link-button astro-UPU6FZXR astro-5EUNQZKT" title=" Facundo's Blog on Github">
  <svg
    xmlns="http://www.w3.org/2000/svg"
    class="icon-tabler"
    stroke-linecap="round"
    stroke-linejoin="round"
  >
    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
    <path
      d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5"
    ></path>
  </svg>
</a><a type="button" href="https://instagram.com/facundomaero" tabindex="0" class="group link-button astro-UPU6FZXR astro-5EUNQZKT" title="Facundo's Blog on Instagram">
  <svg
    xmlns="http://www.w3.org/2000/svg"
    class="icon-tabler"
    stroke-linecap="round"
    stroke-linejoin="round"
  >
    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
    <rect x="4" y="4" width="16" height="16" rx="4"></rect>
    <circle cx="12" cy="12" r="3"></circle>
    <line x1="16.5" y1="7.5" x2="16.5" y2="7.501"></line>
  </svg>
</a><a type="button" href="https://linkedin.com/in/facundojmaero" tabindex="0" class="group link-button astro-UPU6FZXR astro-5EUNQZKT" title="Facundo's Blog on LinkedIn">
  <svg
    xmlns="http://www.w3.org/2000/svg"
    class="icon-tabler"
    stroke-linecap="round"
    stroke-linejoin="round"
  >
    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
    <rect x="4" y="4" width="16" height="16" rx="2"></rect>
    <line x1="8" y1="11" x2="8" y2="16"></line>
    <line x1="8" y1="8" x2="8" y2="8.01"></line>
    <line x1="12" y1="16" x2="12" y2="11"></line>
    <path d="M16 16v-3a2 2 0 0 0 -4 0"></path>
  </svg>
</a><a type="button" href="mailto:facundojmaero@gmail.com" tabindex="0" class="group link-button astro-UPU6FZXR astro-5EUNQZKT" title="Send an email to Facundo's Blog">
  <svg
      xmlns="http://www.w3.org/2000/svg"
      class="icon-tabler"
      stroke-linecap="round"
      stroke-linejoin="round"
    >
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <rect x="3" y="5" width="18" height="14" rx="2"></rect>
      <polyline points="3 7 12 13 21 7"></polyline>
    </svg>
</a>
</div>
    <div class="copyright-wrapper astro-SZ7XMLTE">
      <span class="astro-SZ7XMLTE">Copyright &#169; 2023</span>
      <span class="separator astro-SZ7XMLTE">&nbsp;|&nbsp;</span>
      <span class="astro-SZ7XMLTE">All rights reserved.</span>
    </div>
  </div>
</footer>
  </body></html>